// version 1.03a music player widget and utilites
class PlaylistWidget{constructor(e){this.onClickCallback=e}addEntry(e){$(".old-select option[selected]").removeAttr("selected"),$(".old-select").append('<option value="unused'+e+'" selected>'+e+"</option>"),this.reinit()}setSelection(e){let t;this.openSelect(),$(".old-select option[selected]").removeAttr("selected"),$(".old-select option").each((function(n,i){if(n==e)return t=i.innerHTML,$(this).attr("selected",""),!1})),$(".selection p span").html($(".old-select option[selected]").html());let n=$(".old-select option").size();$(".new-select .new-option").each((function(){$(this).css("z-index",n),n-=1})),this.closeSelect()}_escapeHTML(e){let t=document.createElement("div");return t.innerText=e,t.innerHTML}addClickHandler(e){let t=function(t){if(t.stopPropagation(),!0!==$(".selection").hasClass("open")){let n,i=this._escapeHTML(t.target.innerText);if(void 0===i||!i.length)return;let s=$(".old-select option");s.size();s.each((function(e,t){if((t=t.innerHTML)==i)return n=e,!1})),e(n,i)}}.bind(this);$(".selection").click(t)}openSelect(){let e=$(".new-select").height(),t=1;$(".new-select .new-option").each((function(){$(this).addClass("reveal"),$(this).css({border:"1px solid #999",left:"0",right:"0",top:t*(e+1)+"px"}),t++}))}closeSelect(){$(".new-select .new-option").each((function(){$(this).removeClass("reveal");$(".old-select option").size();$(this).css("top",0),$(this).css("box-shadow","none")}))}reinit(){$(".selection p span").html(""),$(".new-select").html('<div class="selection"><p><span></span><i></i></p><span></span></div>'),1===$(".old-select option[selected]").size()?$(".selection p span").html($(".old-select option[selected]").html()):$(".selection p span").html($(".old-select option:first-child").html()),$(".old-select option").each((function(){let e=$(this).val(),t=$(this).html();$(".new-select").append('<div class="new-option" data-value="'+e+'"><p>'+t+"</p></div>")}));let e=$(".old-select option").size();$(".new-select .new-option").each((function(){$(this).css("z-index",e),e-=1})),this.closeSelect();let t=this;$(".selection").click((function(e){e.stopPropagation(),$(this).toggleClass("open"),!0===$(this).hasClass("open")?t.openSelect():t.closeSelect()})),$(".new-option").click((function(e){e.stopPropagation();let n=$(this).data("value"),i=$(".selection p span").html(),s=$(this).find("p").html();$(".selection p span").html(s),i!=s?$(".selection").click():t.closeSelect(),$(".old-select option[selected]").removeAttr("selected"),$('.old-select option[value="'+n+'"]').attr("selected","")})),this.addClickHandler(this.onClickCallback)}}class PlaylistPlayerWidget{constructor(e,t,n,i,s,o,l,a,d){this._containerId=e,this._onNewTrackCallback=n,this._playlistWidget=new PlaylistWidget(this.onPlaylistClick.bind(this)),this._doOnDropFile=l,this._options=void 0!==d?d:{},this._current=void 0!==a?a:-1,this.setPlaylist(t),this._enableSeek=i,this._enableSpeedTweak=s,this._doParseUrl=o,this._initDomElements()}setPlaylist(e){"[object Array]"===Object.prototype.toString.call(e)?this._someSongs=e:(console.log("warning: no valid song list supplied.. starting empty"),this._someSongs=[])}pause(){ScriptNodePlayer.getInstance().pause()}resume(){ScriptNodePlayer.getInstance().resume()}setVolume(e){ScriptNodePlayer.getInstance().setVolume(e)}getSongInfo(){return ScriptNodePlayer.getInstance().getSongInfo()}onPlaylistClick(e,t){this._playlistWidget.setSelection(e),this._current=e-1,this.playNextSong()}_addSong(e){this._someSongs.push(e),this._playlistWidget.addEntry(this._makeLabel(e)),this._current=this._someSongs.length-1,this._current-=1}seekPos(e){let t=ScriptNodePlayer.getInstance();t&&t.seekPlaybackPosition(Math.round(t.getMaxPlaybackPosition()*e))}removeFromPlaylist(e){}playNextSong(){if(ScriptNodePlayer.getInstance()&&this._someSongs.length){this._current=++this._current>=this._someSongs.length?0:this._current,this._playlistWidget.setSelection(this._current);let e=this._someSongs[this._current];this.playSong(e)}}playPreviousSong(){if(ScriptNodePlayer.getInstance()&&this._someSongs.length){this._current=--this._current<0?this._current+this._someSongs.length:this._current,this._playlistWidget.setSelection(this._current);let e=this._someSongs[this._current];this.playSong(e)}}_playSongWithBackand(e,t){let n=e.backendAdapter;ScriptNodePlayer.initialize(n.adapter,n.doOnTrackEnd,n.basePath,n.preload,n.enableSpectrum).then((e=>{t()}))}playSong(e){let t=ScriptNodePlayer.getWebAudioContext();if("suspended"==t.state){document.getElementById("autoplayConfirm").style.display="block",window.globalDeferredPlay=function(){t.resume(),this._playSong(e)}.bind(this)}else this._playSong(e)}_loadSongFromURL(e,t){let n=function(){this.removeFromPlaylist(e)}.bind(this);ScriptNodePlayer.loadMusicFromURL(e,t,n).then((e=>{document.getElementById("songInfo").innerHTML=this._getInfoLine(this.getSongInfo()),this._onNewTrackCallback()}))}_playSong(e){let t=this._doParseUrl(e),n=t[0],i=t[1];if(void 0!==i.backendAdapter){let e=function(){this._loadSongFromURL(n,i)}.bind(this);this._playSongWithBackand(i,e)}else this._loadSongFromURL(n,i)}_arrayify(e){let t=[];for(let n=0;n<e.length;n++)t.push(e[n]);return t}_drop(e){e.preventDefault();e.dataTransfer.getData("Text");let t=this._arrayify(e.dataTransfer.files);ScriptNodePlayer.getInstance()&&(t.forEach((e=>{e.xname="/tmp/"+e.name})),ScriptNodePlayer.loadFileData(t).then((e=>{e.forEach((e=>{this._addSong(e)})),this.playNextSong()})))}_initExtensions(){}_allowDrop(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}_initUserEngagement(){let e=document.createElement("DIV");e.setAttribute("id","autoplayConfirm"),e.setAttribute("class","modal-autoplay");let t=document.createElement("DIV");t.setAttribute("class","modal-autoplay-content");let n=document.createElement("P"),i=document.createTextNode("This page will auto play music. (You can white list this  \t\tsite to avoid this annoying dialog in the future.)\t\tClick outside of this box to continue.");n.appendChild(i),t.appendChild(n),e.appendChild(t),document.body.insertBefore(e,document.body.firstChild);let s=document.createElement("script");s.text='var modal = document.getElementById("autoplayConfirm");\t\t\twindow.onclick = function(event) {\t\t\t\tif (event.target == modal) {\t\t\t\t\tmodal.style.display = "none";\t\t\t\t\tif (typeof window.globalDeferredPlay !== "undefined") { window.globalDeferredPlay();\t\t\t\t\tdelete window.globalDeferredPlay; }\t\t\t\t}\t\t\t}',document.body.appendChild(s)}_initTooltip(){let e=document.getElementById("tooltip");e.setAttribute("alt","This is a hobby project, but it costs not only time to regularly maintain this site but also money to pay for the internet service provider (etc). If you want to keep this site up and running.. or if you just like my work and you'd like to see more of it in the future, buy me a cup of coffee. Thank you!");let t=document.createElement("form");t.setAttribute("method","post"),t.setAttribute("action","https://www.paypal.com/cgi-bin/webscr"),t.setAttribute("target","_blank");let n=document.createElement("input");n.type="hidden",n.value="_s-xclick",n.name="cmd",t.appendChild(n);let i=document.createElement("input");i.type="hidden",i.value="E7ACAHA7W5FYC",i.name="hosted_button_id",t.appendChild(i);let s=document.createElement("input");s.type="image",s.src="stdlib/btn_donate_LG.gif",s.className="donate_btn",s.border="0",s.name="submit",s.alt="PayPal - The safer, easier way to pay online!",t.appendChild(s);let o=document.createElement("img");o.alt="",o.border="0",o.src="stdlib/pixel.gif",o.width="1",o.height="1",t.appendChild(o),e.appendChild(t)}_initDrop(){window.addEventListener("dragover",(function(e){(e=e||event).preventDefault(),e.dataTransfer.dropEffect="none"}),!0),window.addEventListener("drop",(function(e){(e=e||event).preventDefault()}),!0);let e=document;e.ondrop=this._drop.bind(this),e.ondragover=this._allowDrop.bind(this)}_appendControlElement(e){let t=document.getElementById(this._containerId);t.appendChild(e),t.appendChild(document.createTextNode(" "))}_addSlider(e,t,n,i,s,o){let l=document.createElement("div");l.id=e,l.name=e,l.className="slider "+e;let a=document.createElement("label");a.innerHTML=t,a.className="sliderIconLabel",a.appendChild(l),this._appendControlElement(a),$("#"+e).slider({orientation:"horizontal",range:"min",min:n,max:i,value:s,animate:200,slide:o}),$("#"+e).on("slidestop",o)}_addPlayerButton(e,t,n){let i=document.createElement("BUTTON");i.id=e,i.className="playerBtn",i.innerHTML=t,i.onclick=n,this._appendControlElement(i)}_makeLabel(e){let t,n=e.lastIndexOf("/");if(t=-1==n?e:e.slice(n+1),t=t.split(";")[0],t=t.substr(0,t.indexOf(".")),t.length>40){let e=t.split("-");t=e[e.length-1].trim()}for(;t.length>40;){let e=t.lastIndexOf(" ");t=t.substring(0,e)}return t}_addPlaylist(){let e=document.createElement("DIV");e.className="playlistSelect";let t=' <select class="old-select" >';for(let e=0;e<this._someSongs.length;e++)t+='<option value="opt'+e+'">'+this._makeLabel(this._someSongs[e])+"</option>";t+='</select><div class="new-select" ></div>',e.innerHTML=t,this._appendControlElement(e)}_getInfoLine(e){return""}_addInfoLine(){let e=document.createElement("DIV");e.className="songInfo",e.innerHTML='<p id="songInfo">&nbsp;</p>',this._appendControlElement(e)}_initDomElements(){this._addPlayerButton("play",'<span class="material-icons">&#57399;</span>',function(e){e.stopPropagation(),this.resume()}.bind(this)),this._addPlayerButton("pause",'<span class="material-icons">&#57396;</span>',function(e){e.stopPropagation(),this.pause()}.bind(this)),this._addPlayerButton("previous",'<span class="material-icons">&#57413;</span>',function(e){e.stopPropagation(),this.playPreviousSong()}.bind(this)),this._addPlayerButton("next",'<span class="material-icons">&#57412;</span>',function(e){e.stopPropagation(),this.playNextSong()}.bind(this));let e='<span class="material-icons">&#57424;</span>';if($(".playerRow").click(function(){this._playlistWidget.closeSelect()}.bind(this)),this._addSlider("gain",e,0,255,255,function(t,n){let i=document.getElementById("gain").parentElement.firstChild;0==n.value?i.innerHTML='<span class="material-icons">&#57423;</span>':n.value<127?i.innerHTML='<span class="material-icons">&#57422;</span>':i.innerHTML=e,this.setVolume(parseInt(n.value)/255)}.bind(this)),this._enableSeek){let e=function(e,t){e.stopPropagation(),this.seekPos(t.value/255)}.bind(this);this._addSlider("seekPos","seek",0,255,0,e)}if(this._enableSpeedTweak){let e=function(e,t){e.stopPropagation();let n=ScriptNodePlayer.getInstance(),i=(100-t.value)/50-1,s=ScriptNodePlayer.getWebAudioSampleRate();s=Math.round(s*(1+.2*i)),n.resetSampleRate(s)}.bind(this);this._addSlider("speed",'<span class="material-icons">&#59876;</span>',0,100,50,e)}this._addPlaylist(),this._playlistWidget.reinit(),this._addInfoLine(),this._initUserEngagement(),this._initDrop(),this._initTooltip(),this._initExtensions()}}class OscilloscopesWidget{constructor(e,t,n,i,s){this._divId=e,this._channelStreamer=t,this._backend=n,this._useSyncMode=!0,this._zoomLevel=5,this._width=void 0===i?300:i,this._height=void 0===s?60:s,this._numScopes=0}_genCanvId(e){return"voice"+e+"Canvas"}_syncUI(){let e=this._backend.getNumberTraceStreams();if(e!=this._numScopes){this._scopeDisplays=[],this._generateHTML(this,e);for(let t=0;t<e;t++){let e=new VoiceDisplay(this._genCanvId(t),this._channelStreamer,function(){return this._channelStreamer.getData(t)}.bind(this),!0);e.setSize(this._width,this._height),this._scopeDisplays.push(e)}this._numScopes=e}}_generateHTML(e,t){let n='<div class="oscRow">';for(let e=0,i=0;e<4;e++){n+='<div class="osc'+(e+1)+'">';for(let e=0;e<t/4;e++)n+='<div class="panHead">channel '+i+'</div><div class="voiceContainer"><canvas class="voiceCanvas" id="'+this._genCanvId(i)+'" ></canvas></div>',i++;n+="</div>"}n+="</div>",document.getElementById(this._divId).innerHTML=n}onSongChanged(){void 0!==this._lastId&&window.cancelAnimationFrame(this._lastId),this._redrawRepeated()}_redrawRepeated(){this._redraw(),this._lastId=window.requestAnimationFrame(this._redrawRepeated.bind(this))}_redraw(){this._syncUI();for(let e=0;e<this._numScopes;e++)this._scopeDisplays[e].redrawGraph()}toggleMode(){this._useSyncMode=!this._useSyncMode;for(const e of this._scopeDisplays)e.setSyncMode(this._useSyncMode)}setZoom(e){this._zoomLevel=e,this._channelStreamer.setZoom(this._zoomLevel)}}$((function(){if($("html").addClass($.fn.details.support?"details":"no-details"),$("details").details(),"undefined"!==window.openDetails&&window.openDetails)if($.fn.details.support)$("details").attr("open","");else{let e=$("details"),t=($("summary",e).first(),e.children(":not(summary)"));e.addClass("open").prop("open",!0).triggerHandler("open.details"),t.show()}}));