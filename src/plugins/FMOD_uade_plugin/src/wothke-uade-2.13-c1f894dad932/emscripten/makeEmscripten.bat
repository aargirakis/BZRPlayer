:: **** use the "-s WASM" switch to compile WebAssembly output. warning: the SINGLE_FILE approach does NOT currently work in Chrome 63.. ****

if not exist "built/prowiz.bc" (
:: keeping all the "proviz" files to make it easier to change what is used.. optimizer will cleanout the unused garbage
	call emcc.bat %OPT% -DINCLUDEALL -I../src/prowiz/include/ ../src/prowiz/misc/crc32.c ../src/prowiz/misc/misc.c ../src/prowiz/misc/testbag.c  ../src/prowiz/prowiz.c ../src/prowiz/r/AC1D_packer.c ../src/prowiz/r/AMF.c ../src/prowiz/r/AMOS-MusicBank.c ../src/prowiz/r/AMOS-PPBk.c ../src/prowiz/r/BNR.c ../src/prowiz/r/BP.c ../src/prowiz/r/BSI-FutureComposer.c ../src/prowiz/r/Bytekiller.c ../src/prowiz/r/ChipTracker.c ../src/prowiz/r/Crunchmania-Address.c ../src/prowiz/r/Crunchmania-Simple.c ../src/prowiz/r/DM1.c ../src/prowiz/r/DM2.c ../src/prowiz/r/DefjamCr.c ../src/prowiz/r/Devils.c ../src/prowiz/r/DigiBooster17.c ../src/prowiz/r/DigitalIllusion.c ../src/prowiz/r/DoubleAction.c ../src/prowiz/r/Dragpack100.c ../src/prowiz/r/Dragpack252.c ../src/prowiz/r/EurekaPacker.c ../src/prowiz/r/FC-M-Packer.c ../src/prowiz/r/FC13.c ../src/prowiz/r/FC14.c ../src/prowiz/r/FT2.c ../src/prowiz/r/FuchsTracker.c ../src/prowiz/r/FuzzacPacker.c ../src/prowiz/r/GMC.c ../src/prowiz/r/GNUPacker12.c ../src/prowiz/r/GPMO.c ../src/prowiz/r/GnuPlayer.c ../src/prowiz/r/HCD.c ../src/prowiz/r/HQC2.c ../src/prowiz/r/HeatseekerMC10.c ../src/prowiz/r/HighPresCr.c ../src/prowiz/r/HornetPacker.c ../src/prowiz/r/IFF.c ../src/prowiz/r/IT.c ../src/prowiz/r/JamCracker.c ../src/prowiz/r/KSM.c ../src/prowiz/r/MED-Octamed.c ../src/prowiz/r/MOD-compatible.c ../src/prowiz/r/MastCrunch30-Add.c ../src/prowiz/r/MaxPacker12.c ../src/prowiz/r/MegaCruncher-Obj.c ../src/prowiz/r/MegaCruncher.c ../src/prowiz/r/ModuleProtector.c ../src/prowiz/r/Mosh.c ../src/prowiz/r/Mugician.c ../src/prowiz/r/NP1.c ../src/prowiz/r/NP2.c ../src/prowiz/r/NP3.c ../src/prowiz/r/Newtron.c ../src/prowiz/r/NewtronOld.c ../src/prowiz/r/NoiseFromHeaven.c ../src/prowiz/r/NoiseRunner.c ../src/prowiz/r/NovoTrade.c ../src/prowiz/r/PRT.c ../src/prowiz/r/Perfsong.c ../src/prowiz/r/PhaPacker.c ../src/prowiz/r/PolkaPacker.c ../src/prowiz/r/PowerMusic.c ../src/prowiz/r/PowerPacker23.c ../src/prowiz/r/PowerPacker30.c ../src/prowiz/r/PowerPacker40-lib.c ../src/prowiz/r/PowerPacker40.c ../src/prowiz/r/ProPacker10.c ../src/prowiz/r/ProPacker21.c ../src/prowiz/r/ProPacker30.c ../src/prowiz/r/Promizer01.c ../src/prowiz/r/Promizer10c.c ../src/prowiz/r/Promizer18a.c ../src/prowiz/r/Promizer20.c ../src/prowiz/r/Promizer40.c ../src/prowiz/r/Prorunner10.c ../src/prowiz/r/Prorunner20.c ../src/prowiz/r/QC.c ../src/prowiz/r/RelokIt10.c ../src/prowiz/r/S3M.c ../src/prowiz/r/SA.c ../src/prowiz/r/SGT-Packer.c ../src/prowiz/r/STC270.c ../src/prowiz/r/STC299.c ../src/prowiz/r/STC299b.c ../src/prowiz/r/STC299d.c ../src/prowiz/r/STC300.c ../src/prowiz/r/STC310.c ../src/prowiz/r/SV.c ../src/prowiz/r/SkytPacker.c ../src/prowiz/r/SlamPacker.c ../src/prowiz/r/SoundFX.c ../src/prowiz/r/SoundTracker.c ../src/prowiz/r/SoundTracker26.c ../src/prowiz/r/SpikeCruncher.c ../src/prowiz/r/StartrekkerPack.c ../src/prowiz/r/StimPacker.c ../src/prowiz/r/StoneArtsPlayer.c ../src/prowiz/r/SuperCruncher27.c ../src/prowiz/r/SyncroPacker46.c ../src/prowiz/r/THX.c ../src/prowiz/r/TMK.c ../src/prowiz/r/TNMCruncher.c ../src/prowiz/r/TP22a.c ../src/prowiz/r/TP30a.c ../src/prowiz/r/TP40.c ../src/prowiz/r/TP41a.c ../src/prowiz/r/TP50a.c ../src/prowiz/r/TP60a.c ../src/prowiz/r/TP61a.c ../src/prowiz/r/TetraPack1.c ../src/prowiz/r/TetraPack21.c ../src/prowiz/r/TetraPack22.c ../src/prowiz/r/TheDarkDemon.c ../src/prowiz/r/TimeCruncher17.c ../src/prowiz/r/TitanicsPlayer.c ../src/prowiz/r/TrackerPacker1.c ../src/prowiz/r/TrackerPacker2.c ../src/prowiz/r/TrackerPacker3.c ../src/prowiz/r/TryItCruncher101.c ../src/prowiz/r/TurboSqueezer61.c ../src/prowiz/r/UnicTracker.c ../src/prowiz/r/UnicTracker2.c ../src/prowiz/r/WantonPacker.c ../src/prowiz/r/XannPlayer.c ../src/prowiz/r/ZenPacker.c ../src/prowiz/r/datacrunchers.c ../src/prowiz/r/okta.c ../src/prowiz/r/pmd3.c ../src/prowiz/r/sidmon1.c ../src/prowiz/r/sidmon2.c ../src/prowiz/r/skizzo.c ../src/prowiz/r/struggle.c -o built/prowiz.bc
	IF %ERRORLEVEL% NEQ 0 goto :END
)

if not exist "built/unice68.bc" (
	call emcc.bat  -std=c99  %DEFS% -DPACKAGE_STRING="" -DHAVE_ASSERT_H -DHAVE_STDINT_H -DHAVE_LIBGEN_H -DHAVE_UNISTD_H -DHAVE_FCNTL_H -DHAVE_IO_H -I. -I../src/unice68 ../src/unice68/unice68_unpack.c ../src/unice68/unice68_pack.c ../src/unice68/unice68_version.c  -o built/unice68.bc
	IF %ERRORLEVEL% NEQ 0 goto :END
)

emcc.bat -s WASM=1 -s ASSERTIONS=1 -s SAFE_HEAP=0 -s TOTAL_MEMORY=33554432 --pre-js pre.js --js-library callback.js -s VERBOSE=0 -s FORCE_FILESYSTEM=1 -Wno-pointer-sign -I./ -I../src/ -I../src/unice68 -I../src/decrunch -I../src/include -I../src/frontends/common -I../amigasrc/score -Os -O3 --memory-init-file 0 --closure 1 --llvm-lto 1 built/unice68.bc built/prowiz.bc ../src/decrunch/decrunch.c ../src/decrunch/ppdepack.c ../src/decrunch/mmcmp.c ../src/decrunch/s404_dec.c ../src/decrunch/unsqsh.c ../src/decrunch/compat.c ../src/newcpu.c ../src/audiodevice.c ../src/memory.c ../src/custom.c ../src/cia.c ../src/audio.c ../src/cpustbl.c ../src/missing.c ../src/sd-sound.c ../src/md-support.c ../src/cfgfile.c ../src/fpp.c ../src/readcpu.c ../src/cpudefs.c ../src/cpuemu1.c ../src/cpuemu2.c ../src/cpuemu3.c ../src/cpuemu4.c ../src/cpuemu5.c ../src/cpuemu6.c ../src/cpuemu7.c ../src/cpuemu8.c ../src/uade.c ../src/unixatomic.c ../src/ossupport.c ../src/uademain.c ../src/sinctable.c ../src/text_scope.c ../src/frontends/common/effects.c ../src/frontends/common/uadeconf.c ../src/frontends/common/support.c ../src/frontends/common/songinfo.c ../src/frontends/common/songdb.c ../src/frontends/common/amifilemagic.c ../src/frontends/common/eagleplayer.c Adapter.cpp -s EXPORTED_FUNCTIONS="['_emu_prepare','_emu_load_file','_emu_compute_audio_samples','_emu_teardown','_emu_get_audio_buffer','_emu_set_subsong','_emu_get_audio_buffer_length', '_malloc', '_free', '_putchar', '_emu_get_trace_streams', '_emu_number_trace_streams', '_emu_set_panning']"  -o htdocs/uade.js -s SINGLE_FILE=0 -s EXTRA_EXPORTED_RUNTIME_METHODS="['ccall', 'getValue', 'UTF8ToString', 'Pointer_stringify']"  -s BINARYEN_ASYNC_COMPILATION=1  && copy /b shell-pre.js + htdocs\uade.js + shell-post.js htdocs\web_uade.js && del htdocs\uade.js && copy /b htdocs\web_uade.js + uade_adapter.js htdocs\backend_uade.js && del htdocs\web_uade.js

:: **** use the "-s WASM" switch to compile WebAssembly output. warning: the SINGLE_FILE approach does NOT currently work in Chrome 63.. ****
::set "OPT= -s WASM=0 -s ASSERTIONS=0 --pre-js pre.js --js-library callback.js -s VERBOSE=0 -s FORCE_FILESYSTEM=1 -Wno-pointer-sign -I../src/ -I../src/include -I../src/frontends/common -Os -O3 "

::if not exist "built/uade.bc" (
::	call emcc.bat %OPT% ../src/newcpu.c ../src/memory.c ../src/custom.c ../src/cia.c ../src/audio.c ../src/compiler.c ../src/cpustbl.c ../src/missing.c ../src/sd-sound.c ../src/md-support.c ../src/cfgfile.c ../src/fpp.c ../src/readcpu.c ../src/cpudefs.c ../src/cpuemu1.c ../src/cpuemu2.c ../src/cpuemu3.c ../src/cpuemu4.c ../src/cpuemu5.c ../src/cpuemu6.c ../src/cpuemu7.c ../src/cpuemu8.c ../src/uade.c ../src/unixatomic.c ../src/ossupport.c ../src/uademain.c ../src/sinctable.c ../src/text_scope.c ../src/frontends/common/effects.c ../src/frontends/common/uadeconf.c ../src/frontends/common/support.c ../src/frontends/common/songinfo.c ../src/frontends/common/songdb.c ../src/frontends/common/amifilemagic.c ../src/frontends/common/eagleplayer.c	 -o built/uade.bc
::	IF %ERRORLEVEL% NEQ 0 goto :END
::)
::call emcc.bat  %OPT% --closure 1 --llvm-lto 1 --memory-init-file 0  built/uade.bc adapter.c -s EXPORTED_FUNCTIONS="['_emu_prepare','_emu_load_file','_emu_is_exit','_emu_compute_audio_samples','_emu_teardown','_emu_get_audio_buffer','_emu_set_subsong','_emu_get_audio_buffer_length', '_malloc', '_free', '_emu_set_panning']"  -o htdocs/uade.js -s SINGLE_FILE=0 -s EXTRA_EXPORTED_RUNTIME_METHODS="['ccall', 'getValue', 'UTF8ToString', 'Pointer_stringify']"  -s BINARYEN_ASYNC_COMPILATION=1 -s BINARYEN_TRAP_MODE='clamp' && copy /b shell-pre.js + htdocs\uade.js + shell-post.js htdocs\web_uade.js && del htdocs\uade.js && copy /b htdocs\web_uade.js + uade_adapter.js htdocs\backend_uade.js && del htdocs\web_uade.js

:END

::  -DMPT_PROJECT_NAMESPACE=mpt -DMPT_LIBCXX_QUIRK_NO_HAS_UNIQUE_OBJECT_REPRESENTATIONS -DMPT_COMPILER_QUIRK_NO_AUTO_TEMPLATE_ARGUMENT